<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>:wq</title>

        <!-- jQuery -->
        <!-- <script src="https://aga3.xyz/./theme/static/js/jquery.js"></script> -->
        <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <script src="https://aga3.xyz/./theme/static/js/bootstrap.min.js"></script>
        <!-- Bootstrap Core CSS -->
        <link href="https://aga3.xyz/./theme/static/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom Theme JavaScript -->
        <script src="https://aga3.xyz/./theme/static/js/clean-blog.min.js"></script>

        <!-- Custom CSS -->
        <link href="https://aga3.xyz/./theme/static/css/clean-blog.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="https://aga3.xyz/./theme/static/css/code_blocks/tomorrow_night.css" rel="stylesheet">

        <!-- FontAwesome JavaScript -->
        <script src="https://kit.fontawesome.com/3abd13917d.js"></script>

            <link href="https://aga3.xyz/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title=":wq Full Atom Feed" />

        <!-- Custom Fonts
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'> -->

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->





     <link rel="canonical" href="https://aga3.xyz/2021/05/raytracing-in-rust-part-1" />


			<meta property="og:locale" content="en">
		<meta property="og:site_name" content=":wq">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="https://aga3.xyz/2021/05/raytracing-in-rust-part-1">
	<meta property="og:title" content="Raytracing in Rust Part 1">
	<meta property="og:description" content="">
	<meta property="og:image" content="https://aga3.xyz//images/raytracing_cover_render.png">
	<meta property="article:published_time" content="2021-05-28 23:36:00-04:00">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://aga3.xyz/">:wq</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

						<li><a href="https://aga3.xyz/about-me/">About Me</a></li>
						<li><a href="https://aga3.xyz/projects/">Projects</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('/images/raytracing_cover_render.png')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2">
                    <div class="post-heading">
                        <h1>Raytracing in Rust Part 1</h1>
                        <span class="meta">
                             Friday May 28, 2021
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2">
    <!-- Post Content -->
    <article>
        <p>I write a lot of Python, but I wanted to get back into practice with a
lower-level language. I've done a decent amount of C and C++ programming, but
it seems like everyone who tries Rust really likes it so I took it for a spin.</p>
<p>You can find my code for this project on GitHub: https://github.com/aganders3/wasm-ray</p>
<h1>Learning Rust</h1>
<p>The first step was to learn a bit about Rust. I started how they recommend on
rust-lang.org, by reading <a href="https://doc.rust-lang.org/book/">The Rust Book</a>.</p>
<p>Next I worked through all the excellent exercises in the <a href="https://github.com/rust-lang/rustlings/">Rustlings
Course</a>.</p>
<p>Finally, I picked a couple projects:</p>
<ol>
<li>I wrote a simple <a href="https://github.com/aganders3/rush"><code>shell</code></a> in the
spirit of an assignment I found from a <a href="http://pages.cs.wisc.edu/~dusseau/Classes/CS537-F07/Projects/P1/p1.html">CS course at my alma
mater</a> </li>
<li>I wanted to do something more visual; I work in medical imaging and enjoyed
computer graphics class in grad school. I happened to catch a talk by <a href="https://twitter.com/Peter_shirley">Peter
Shirley</a> at Nvidia's GTC '21 called <em>Ray
Tracing in One Weekend</em>. I found out that's actually <a href="https://raytracing.github.io">part of a series of
great books</a> and I was off and running.</li>
</ol>
<h1>Ray Tracing in Rust</h1>
<p><em>Ray Tracing in One Weekend</em> is somewhat like a tutorial, but it's
intentionally general to allow freedom in selection of programming language and
certain implementation details. It's really a great framework for
non-copy-paste learning. On top of that, graphics programming is a great tool
for learning a language because you can do visual debugging and get the
satisfaction of making an image (as opposed to, say, calculating pi).</p>
<p>I was also drawn to Rust with some interest in WebAssembly (or wasm). That was
intended to be a larger part of this project, but I ended up hitting some
performance bottlenecks early that made it less fun. I may revisit this because
having a live demo is pretty cool, but for now I have decided to proceed with
the rest of the rendering features first. Perhaps I'll write more on this
later.</p>
<h2>The Vec3 Class</h2>
<p>We're talking 3D graphics, so we'll need 3, uh, dimensions. The first step is
making a very simple struct to hold a 3D vector or point.</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Vec3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">x</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">y</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">z</span>: <span class="kt">f32</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">Point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec3</span><span class="p">;</span><span class="w"></span>
</code></pre></div>


<p>Rust is easy!</p>
<p>Or is it? What if we want to be able to add two of these together?
An interesting thing about Rust is that you don't overload operators <em>on</em> a
struct (which is <em>close enough</em> to a class for now) but <em>for</em> the struct.</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">ops</span>::<span class="n">Add</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Vec3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">Self</span><span class="p">{</span><span class="n">x</span>: <span class="nc">self</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="nc">self</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span>: <span class="nc">self</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">z</span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>That's neat! This is called a <em>Trait</em> and it is a really useful and flexible
paradigm. Hopefully I can demonstrate later how this pattern encourages
<em>composition over inheritance</em> which is something you hear often, but working
with Rust has helped me understand much better. (This is the carrot; Rust not
supporting inheritance is the stick.)</p>
<p>Something that is really neat about traits: you can implement them on types you
didn't define, including standard types. That's how we can implement
commutative addition with our Vec3 and floats. It's a little verbose, but also
pretty clear:</p>
<div class="highlight"><pre><span></span><code><span class="n">impl</span> <span class="n">ops</span><span class="p">::</span><span class="k">Add</span><span class="o">&lt;</span><span class="n">Vec3</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">f32</span> <span class="err">{</span>
    <span class="k">type</span> <span class="k">Output</span> <span class="o">=</span> <span class="n">Vec3</span><span class="p">;</span>

    <span class="n">fn</span> <span class="k">add</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">Vec3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vec3</span> <span class="err">{</span>
        <span class="n">Vec3</span><span class="err">{</span><span class="n">x</span><span class="p">:</span> <span class="k">self</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="k">self</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="k">self</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">.</span><span class="n">z</span><span class="err">}</span>
    <span class="err">}</span>
<span class="err">}</span>

<span class="n">impl</span> <span class="n">ops</span><span class="p">::</span><span class="k">Add</span><span class="o">&lt;</span><span class="n">f32</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Vec3</span> <span class="err">{</span>
    <span class="k">type</span> <span class="k">Output</span> <span class="o">=</span> <span class="k">Self</span><span class="p">;</span>

    <span class="n">fn</span> <span class="k">add</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="n">rhs</span><span class="p">:</span> <span class="n">f32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span> <span class="err">{</span>
        <span class="k">Self</span><span class="err">{</span><span class="n">x</span><span class="p">:</span> <span class="k">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="k">self</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="k">self</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">rhs</span><span class="err">}</span>
    <span class="err">}</span>
<span class="err">}</span>
</code></pre></div>


<p>Of course, you can also implement methods for the struct that don't come from
any traits. Ultimately this is just allows us to call functions with
<code>foo.bar(baz)</code> instead of <code>bar(foo, baz)</code> but it is handy and familiar.
Implementing this way also allows eliding some of the type annotations, so the
function definitions look a little nicer as well. It's also a decent way to
group related functions even if they don't make use of <code>self</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Vec3</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dot</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">z</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">cross</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">Self</span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">x</span>: <span class="nc">self</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">y</span>: <span class="nc">self</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">z</span>: <span class="nc">self</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">length_squared</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f32</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">z</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">length</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f32</span> <span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="bp">self</span><span class="p">.</span><span class="n">length_squared</span><span class="p">().</span><span class="n">sqrt</span><span class="p">()</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">unit</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="bp">self</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>


<p>Note I did this all hard-coded for single-precision <code>f32</code> values, but Rust also
supports generics. I haven't really dived into that yet.</p>
<p>This Vec3 class could also be used for colors, but I didn't see a way to rename
fields but keep the field types so unfortunately I reimplemented a lof of this
for colors. I also initially started with RGBA <code>u8</code> colors, but eventually
reverted that as it was finicky and against the grain of the book.</p>
<h1>Next time</h1>
<p>That's enough for today. The next post will cover my implmentation of the rays
we will be shooting into the scene.</p>
    </article>

    <hr>

            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <p class="copyright text-muted">Blog powered by <a href="http://getpelican.com">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.</p>
                </div>
            </div>
        </div>
    </footer>


</body>

</html>